var selectedCategory = 'all';
var flagResetCustomStart = false;
var players = new Array();
var flagYTinitlaized = false;
var flagYTPlaying = false;

function pauseAllVideo() {
    
    if(!flagYTPlaying) {
        return;
    }

    for (var key in players) {
        // check if the property/key is defined in the object itself, not in parent
        if (players.hasOwnProperty(key)) {
            players[key].pauseVideo();
        }
    }

    flagYTPlaying = false;

    jQuery('video').each(function(){
        jQuery(this)[0].pause();
    });
}

function onPlayerReady(event) {
    //event.target.playVideo();
}

function playVideo(id) {
    
    if(flagYTinitlaized) {   
        jQuery('.mt_slider').slick('slickPause');
        players[id].playVideo();   
        setTimeout(function(){ 
            jQuery('iframe#'+id).parent().find('div.youtube_custom_play').hide();
            jQuery('iframe#'+id).parent().find('div.youtube_thumb').hide();                         
        }, 500);                
        if(jQuery('.mt_control_btn .mt_play').length && !jQuery('.mt_control_btn .mt_play').hasClass('paused')){
            jQuery('.mt_play').addClass('video_pause paused');
        }
    }    
}

function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
        jQuery('.mt_slider').slick('slickPause');
        if(jQuery('.mt_control_btn .mt_play').length && !jQuery('.mt_control_btn .mt_play').hasClass('paused')){
            jQuery('.mt_play').addClass('video_pause paused');
        }
        flagYTPlaying = true;
    } else {
        if(jQuery('.mt_control_btn .mt_play').hasClass('video_pause')){
            jQuery('.mt_slider').slick('slickPlay');
            if(jQuery('.mt_control_btn .mt_play').length){
                jQuery('.mt_play').removeClass('video_pause paused');
            }
        }
    }
}

function onYouTubeIframeAPIReady() {
        
    jQuery('iframe.youtube').each(function(i){
        var playerId = jQuery(this).attr('id');
        if(playerId !== ''){
            players[playerId] = new YT.Player(playerId, {
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
    });

    flagYTinitlaized = true;
}

function slideToSelectedCategory(selectedCategory) {
    if (selectedCategory == 'all') {
        jQuery('.mt_slider').slick('slickGoTo', 0, true);
    } else {
        var index = parseInt(jQuery('.mt_slider').find('div.'+selectedCategory).not('div.slick-cloned').index());
        jQuery.browser.chrome = /chrom(e|ium)/.test(navigator.userAgent.toLowerCase());
        if(jQuery.browser.chrome){

        } else {
            index = parseInt(index)-1;
        }
        jQuery('.mt_slider').slick('slickGoTo', index, true);
    }

    jQuery('.mt_slider').slick('slickPlay');
    jQuery('.mt_play').removeClass('paused');
}

function updateCaption() {
    var caption = jQuery('div.mt_slide.slick-active').data('caption');
    if(caption == ''){
        jQuery('.mt_gallery_caption p.mt_txt_intro').addClass('no_caption');
    }
    else{
        jQuery('.mt_gallery_caption p.mt_txt_intro').removeClass('no_caption');
    }
    jQuery('p.mt_txt_intro').html(caption);
}

function resetCustomStartSlide() {
    var startingSlideNumber = 0;

    if( jQuery('input[name=hidden_unique_slide]').length ) {
      var slide_name = jQuery('input[name=hidden_unique_slide]').val();
      if(slide_name) {
        var startingSlideNumber = parseInt(jQuery('.mt_slider').find('.mt_slide[data-slide-name="'+slide_name+'"]').not('div.slick-cloned').index());            
      }          
    } 

    if(startingSlideNumber > 0) {
        jQuery('.mt_banner .mt_slider').slick('slickSetOption', 'autoplay', true, true);
        jQuery('.mt_play').removeClass('paused');
        window.history.replaceState({}, document.title, "/" + "gallery/");
        flagResetCustomStart = true;
    }
}

jQuery(document).ready(function(){

    var tag = document.createElement('script');
    tag.src = "//www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    jQuery('#category_selector button').click(function(){
        selectedCategory = jQuery(this).data('category');
        slideToSelectedCategory(selectedCategory);
    });

    jQuery('.mt_slider').on('afterChange', function(event, slick, currentSlide, nextSlide){

        pauseAllVideo();

        if(!flagResetCustomStart) {
            resetCustomStartSlide();
        }        

        var category = jQuery('div.mt_slide.slick-active').data('category');

        if (selectedCategory != 'all') {
            jQuery('#category_selector button').removeClass('selectivo__option--selected infocus');
            jQuery('#category_selector button.'+category).addClass('selectivo__option--selected infocus');
            var totalSlides = parseInt(jQuery('.mt_slider').find('div.'+category).not('div.slick-cloned').length);
            jQuery('.currentSlide').html(jQuery('div.mt_slide.slick-active').data('currentslide'));
            jQuery('.totalSlide').html(totalSlides);
            jQuery('.mt_tab_mob.selectivo__label').html(category);
        } else {
            jQuery('.currentSlide').html(currentSlide+1);
            jQuery('.totalSlide').html(slick.slideCount);
        }

        if (category == 'video') {

            jQuery('div.mt_slide.slick-active video').on('play', function (e) {
                jQuery('.mt_slider').slick('slickPause');
                if(jQuery('.mt_control_btn .mt_play').length && !jQuery('.mt_control_btn .mt_play').hasClass('paused')){
                    jQuery('.mt_play').addClass('video_pause paused');
                }
            });

            jQuery('div.mt_slide.slick-active video').on('ended', function (e) {
                if(jQuery('.mt_control_btn .mt_play').hasClass('video_pause')){
                    jQuery('.mt_slider').slick('slickPlay');
                    if(jQuery('.mt_control_btn .mt_play').length){
                        jQuery('.mt_play').removeClass('video_pause paused');
                    }
                }
            });

            jQuery('div.mt_slide.slick-active video').on('pause', function (e) {
                if(jQuery('.mt_control_btn .mt_play').hasClass('video_pause')){
                    jQuery('.mt_slider').slick('slickPlay');
                    if(jQuery('.mt_control_btn .mt_play').length){
                        jQuery('.mt_play').removeClass('video_pause paused');
                    }
                }
            });
        }
        else{
            if(jQuery('.mt_control_btn .mt_play').length && jQuery('.mt_control_btn .mt_play').hasClass('video_pause')){
                jQuery('.mt_slider').slick('slickPlay');
                jQuery('.mt_play').removeClass('video_pause paused');
            }
        }

        updateCaption();
    });

    jQuery('.youtube_custom_play').click(function(){
        var playerId = jQuery(this).parent().find('iframe').attr('id');
        playVideo(playerId);
    });

});